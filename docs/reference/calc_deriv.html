<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Calculate the derivatives of the IND response functions and the proportion
of pressure range in which the response is significant — calc_deriv • INDperform</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  <link href="../extra.css" rel="stylesheet">
  

<meta property="og:title" content="Calculate the derivatives of the IND response functions and the proportion
of pressure range in which the response is significant — calc_deriv" />
<meta property="og:description" content="In the case of non-linear IND responses to pressures first derivatives
of the response curve are calculated to identify whether the IND ceases
to respond at the lower or upper end of the pressure range (relevant for
sub-crit. 9.2). calc_deriv serves as a wrapper function that filters
first the model input tibble and applies as default method the `conditional
bootstrap` (see the function cond_boot). It calculates from
the computed bootstrapped derivatives and confidence intervals the
proportion of pressure range in which the IND shows a significant change.
The implementation of the `conditional bootstrap` for Generalized Additive
Mixed Models (GAMMs) has some caveats (see Details), which is why
we implemented additionally a rather quick-and-dirty approach (through the
approx_deriv function). In the `approx_deriv` method derivatives
are calculated directly from the smoothing curve of the original method. The
confidence intervals are then just approximated from the standard errors of the
smoothing curve. For more informations on this method see
approx_deriv." />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">INDperform</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Datasets &amp; Functions
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="https://doi.org/10.1016/j.ecolind.2017.05.045">Quantitative framework for selecting and validating food web indicators</a>
    </li>
    <li>
      <a href="https://raw.githubusercontent.com/saskiaotto/cheatsheets/476bad4a8876939a7b3e1784a5bf61567ed4a715/Cheatsheet_INDperform_v0.1.0.pdf">Indperform cheatsheet</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/saskiaotto/INDperform">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../mailto:saskia.otto@uni-hamburg.de">
    <span class="fa fa-send"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate the derivatives of the IND response functions and the proportion
of pressure range in which the response is significant</h1>
    <small class="dont-index">Source: <a href='https://github.com/saskiaotto/INDperform/blob/master/R/calc_deriv.R'><code>R/calc_deriv.R</code></a></small>
    <div class="hidden name"><code>calc_deriv.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>In the case of non-linear IND responses to pressures first derivatives
of the response curve are calculated to identify whether the IND ceases
to respond at the lower or upper end of the pressure range (relevant for
sub-crit. 9.2). <code>calc_deriv</code> serves as a wrapper function that filters
first the model input tibble and applies as default method the `conditional
bootstrap` (see the function <code><a href='cond_boot.html'>cond_boot</a></code>). It calculates from
the computed bootstrapped derivatives and confidence intervals the
proportion of pressure range in which the IND shows a significant change.
The implementation of the `conditional bootstrap` for Generalized Additive
Mixed Models (GAMMs) has some caveats (see <em>Details</em>), which is why
we implemented additionally a rather quick-and-dirty approach (through the
<code><a href='approx_deriv.html'>approx_deriv</a></code> function). In the `approx_deriv` method derivatives
are calculated directly from the smoothing curve of the original method. The
confidence intervals are then just approximated from the standard errors of the
smoothing curve. For more informations on this method see
<code><a href='approx_deriv.html'>approx_deriv</a></code>.</p>
    </div>

    <pre class="usage"><span class='fu'>calc_deriv</span><span class='op'>(</span>
  <span class='va'>init_tbl</span>,
  <span class='va'>mod_tbl</span>,
  edf_filter <span class='op'>=</span> <span class='fl'>1.5</span>,
  sign_level <span class='op'>=</span> <span class='fl'>0.05</span>,
  excl_outlier <span class='op'>=</span> <span class='cn'>FALSE</span>,
  method <span class='op'>=</span> <span class='st'>"cond_boot"</span>,
  n_boot <span class='op'>=</span> <span class='fl'>200</span>,
  ci_boot <span class='op'>=</span> <span class='fl'>0.95</span>,
  ci_prop_se <span class='op'>=</span> <span class='fl'>25</span>,
  par_comp <span class='op'>=</span> <span class='cn'>FALSE</span>,
  no_clust <span class='op'>=</span> <span class='cn'>NULL</span>,
  seed <span class='op'>=</span> <span class='cn'>NULL</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>init_tbl</th>
      <td><p>The output tibble of the <code><a href='ind_init.html'>ind_init</a></code> function.</p></td>
    </tr>
    <tr>
      <th>mod_tbl</th>
      <td><p>A model output tibble from <code><a href='model_gam.html'>model_gam</a></code>,
<code><a href='select_model.html'>select_model</a></code> or <code><a href='merge_models.html'>merge_models</a></code> representing the
best model for each IND~pressure pair.</p></td>
    </tr>
    <tr>
      <th>edf_filter</th>
      <td><p>The minimum edf value at which derivatives are calculated
for the respective model. The default is set to 1.5.</p></td>
    </tr>
    <tr>
      <th>sign_level</th>
      <td><p>Significance level for selecting models on which to calculate
the derivatives. Only models with a p value smaller than the sign_level will be
selected; the default is 0.05.</p></td>
    </tr>
    <tr>
      <th>excl_outlier</th>
      <td><p>logical; if TRUE, the outliers excluded in the original
models will be also excluded in the bootstrapped models.</p></td>
    </tr>
    <tr>
      <th>method</th>
      <td><p>Method for calculating derivatives and CI; can be either `conditional
bootstrap` (default) or `approx_deriv`.</p></td>
    </tr>
    <tr>
      <th>n_boot</th>
      <td><p>Number of bootstraps. Select n_boot so that (n_boot - (n_boot *ci)) / 2
will be an integer. Otherwise, the function will increase n_boot automatically.
The default is set to 200.</p></td>
    </tr>
    <tr>
      <th>ci_boot</th>
      <td><p>Confidence interval of the bootstrapped smoothing functions and their
derivatives. Must be between 0 and 1, default is 0.95.</p></td>
    </tr>
    <tr>
      <th>ci_prop_se</th>
      <td><p>A conversion factor for approximating derivative CIs in the
`approx_deriv` method; it is multiplied with the ratio between s.e. and mean fitted
values of the smoothing curve to represent some level of uncertainty around the
slope proportional to the uncertainty in the smoothing curve. Default is 25,
which is a compromise representing fairly well the results obtained for the GAMs
from the conditional bootstrap.</p></td>
    </tr>
    <tr>
      <th>par_comp</th>
      <td><p>logical; if TRUE, the conditional bootstrap will be processed in
parallel using several clusters, which can speed up the iteration process depending
on the number of n_boot, models to bootstrap and number of processor cores.</p></td>
    </tr>
    <tr>
      <th>no_clust</th>
      <td><p>Number of clusters ("workers") for the parallel computation, with one
cluster per core. If no_clust is set to NULL default, the number of clusters is set
as the numbers of available cores – 1.</p></td>
    </tr>
    <tr>
      <th>seed</th>
      <td><p>A single value, interpreted as an integer, which specifies the seed
of the random number generator (RNG) state for reproducibility. Due to the work
splitting in the parallel computation, RNG streams are not comparable with the
stream under serial computation. To reproduce results use the same type of
computation with the same seed and number of clusters.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The function returns the input model tibble with the following 12 columns added</p><dl>
  <dt><code>prop</code></dt><dd><p>The proportion of the observed pressure range where the IND
             indicator shows a response (see the last section in <em>Details</em>).
             Significant models with edf &lt; edf_filter get as default a value
             of 1.0 (i.e., the IND responses to the entire observed pressure
             range).</p></dd>
  <dt><code>zero_in_conf</code></dt><dd><p>A list-column of logical vectors indicating for
             every pressure value (in press_seq) whether the slope of the IND
             response at that pressure value is within the confidence interval,
             i.e. is zero.</p></dd>
  <dt><code>zic_start_end</code></dt><dd><p>A list-column of logical vectors indicating for
             every pressure value (in press_seq) whether the slope is considered
             as zero for the proportion calculation (see the last section in
             <em>Details</em>).</p></dd>
  <dt><code>press_seq</code></dt><dd><p>A list-column with sequences of 100 evenly spaced
             pressure values.</p></dd>
  <dt><code>pred</code></dt><dd><p>A list-column with the predicted indicator responses
             averaged across all bootstraps (for the 100 equally spaced
             pressure values).</p></dd>
  <dt><code>pred_ci_up</code></dt><dd><p>A list-column with the upper confidence limit of the
             bootstrapped predictions.</p></dd>
  <dt><code>pred_ci_low</code></dt><dd><p>A list-column with the lower confidence limit of the
             bootstrapped predictions.</p></dd>
  <dt><code>deriv1</code></dt><dd><p>A list-column with the first derivatives of the indicator
             responses averaged across all bootstraps (for the 100 equally spaced
             pressure values).</p></dd>
  <dt><code>deriv1_ci_up</code></dt><dd><p>A list-column with the upper confidence limit of the
             bootstrapped first derivatives.</p></dd>
  <dt><code>deriv1_ci_low</code></dt><dd><p>A list-column with the lower confidence limit of the
             bootstrapped first derivatives.</p></dd>
  <dt><code>adj_n_boot</code></dt><dd><p>The number of successful bootstrap samples that was
             actually used for calculating the mean and confidence intervals of
             the predicted indicator response and the derivative.</p></dd>
  <dt><code>boot_error</code></dt><dd><p>A list-column capturing potential error messages that
             occurred as side effects when refitting the GAM(M)s on each bootstrap
             sample.</p></dd>

</dl><p>If none of the significant models has edf &gt; edf_filter, only the variable <code>prop</code>
will be added. If the `approx_deriv` method was used, the output tibble will
not contain the <code>pred</code>, <code>pred_ci_up</code>, and <code>pred_ci_low</code> variables.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>In the case of non-linear IND responses to pressures first derivatives
of the response curve are calculated to identify whether the IND ceases
to respond at the lower or upper end of the pressure range (relevant for
sub-crit. 9.2).</p>
<p><strong>First Derivative:</strong></p>
<p>The first derivative of a smoothing function i.e. s`(x),
represents the instantaneous rate of change of a dependent variable y to
that of the independent variable x. It tells us whether a function is
increasing or decreasing, and by how much. This information is reflected by
the slope of the tangent line to a point x on the graph of a function.
A positive slope tells us that, as x increases, s(x) also increases.
Derivatives can be applied to any function, even one as potentially
complex as a fitted spline function, by using the method of finite
differences (Trenkel and Rochet, 2009) as done in the <code><a href='cond_boot.html'>cond_boot</a></code>
function: The local first derivatives of the fitted GAM(M) time series
is estimated as the difference between fitted values at time step t and
t + d divided by d, where d is a small value, e.g. 1E-7.</p>
<p><strong>Confidence intervals (CI) based on a conditional bootstrap:</strong></p>
<p>By calculating approximate confidence intervals for s`(x), it may
be determined whether or not apparent IND changes are statistically
significant, i.e. whether the non-zero estimate obtained for
the slope is distinguishable from zero given the uncertainty in the
estimate (Fewster et al., 2000). To estimate the CI of
the estimated first derivative, a conditional bootstrap is
carried out by resampling from the GAM residuals (in the
<code><a href='cond_boot.html'>cond_boot</a></code> function) (Large <em>et al.</em>, 2013).
This approach has the advantage to retain the information in the
pressure variable and to be distribution-free.</p>
<p>In specific, new IND time series are created in <code><a href='cond_boot.html'>cond_boot</a></code> by
resampling from the residuals of the original IND-Pressure GAM(M) and
adding these to the original IND time series repeatedly (the number of
repetitions is defined by n_boot).
A separate GAM(M) is then fitted to each bootstrap IND
time series in <code><a href='cond_boot.html'>cond_boot</a></code>, using the same effective degrees
of freedom (edf) as found optimal for the original IND time series. For
each of the bootstrapped GAMs, predicted IND time series given an evenly
spaced pressure sequence are produced for which the first derivatives
are calculated. Confidence intervals are computed by sorting the
bootstrapped derivatives into ascending order and calculating the
upper and lower percentiles defined by the <code>ci</code> argument (the
default is the 2.5% and 97.5% percentiles representing the 95% CI).</p>
<p>A problem with GAMMs is that the smoothing parameters cannot be fixed,
because the <code><a href='https://rdrr.io/pkg/mgcv/man/gamm.html'>gamm</a></code> function will treat the wiggly
components of the smooth terms as random effects, the variance of which
to be estimated by lme. Hence, the GAMMs refitted on the bootstrapped IND
time series are allowed to have every shape from linear to the max. edfs
set originally. This leads to often positive as well as negative linear
smoothers, which increases the confidence intervals of both fitted
smoothers as well as derivative. When the IND response is weak and/or
the error around the smoother high, the implemented routine to estimate
the proportion of pressure range with significant slope can lead to 0%.
For those models, the method `approx_deriv` can be applied for comparison.</p>
<p><strong>Calculating the proportion of pressure range:</strong></p>
<p>The lack of any further IND response to pressure changes at
its minimum or maximum measured is noted when zero is contained
within the CI of the first derivative and quantified by calculating the
proportion of points (evenly distributed along the pressure axis)
inside the CI for scoring criteria 10.2. In specific,
<code>calc_deriv</code> implements a routine, which identifies
first which pressure values has a slope of zero (see the returned
list-column <code>zero_in_conf</code>). It then checks whether the first
value in <code>zero_in_conf</code> is TRUE (i.e., the lowest value of the
evenly spaced pressure sequence has zero slope). If so, the first value
in the vector zic_start_end (see the returned list-column
<code>zic_start_end</code>) is also set to TRUE, meaning it goes into
the proportion calculation as no IND response. The routine proceeds
to the next values <code>zero_in_conf</code> and stops at the first FALSE value.
It then starts the same procedure from end of the <code>zero_in_conf</code>
vector. The proportion of pressure range (returned as <code>prop</code>
variable in the output tibble) reflects the proportion of FALSE values
in <code>zero_in_conf</code>.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Fewster, R.M., Buckland, S.T., Siriwardena, G.M., Baillie, S.R., Wilson, J.D. (2000)
Analysis of population trends for farmland birds using generalized additive models.
<em>Ecology</em> 81, 1970-1984.</p>
<p>Large, S.I., Fay, G., Friedland, K.D., Link, J.S. (2013) Defining trends and thresholds in
responses of ecological indicators to fishing and environmental pressures.
<em>ICES Journal of Marine Science</em> 70, 755-767.</p>
<p>Trenkel, V.M., Rochet, M.J. (2009) Intersection-union tests for characterizing recent
changes in smoothed indicator time series. <em>Ecological Indicators</em> 9, 732-739.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='cond_boot.html'>cond_boot</a></code> and <code><a href='approx_deriv.html'>approx_deriv</a></code></p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># \donttest{</span>
<span class='co'># Using some models of the Baltic Sea demo data</span>
<span class='va'>init_tbl</span> <span class='op'>&lt;-</span> <span class='va'>ind_init_ex</span><span class='op'>[</span><span class='va'>ind_init_ex</span><span class='op'>$</span><span class='va'>id</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>5</span>,<span class='fl'>9</span>,<span class='fl'>48</span>,<span class='fl'>75</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>mod_tbl</span> <span class='op'>&lt;-</span> <span class='va'>merge_models_ex</span><span class='op'>[</span><span class='va'>merge_models_ex</span><span class='op'>$</span><span class='va'>id</span>  <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>5</span>,<span class='fl'>9</span>,<span class='fl'>48</span>,<span class='fl'>75</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>deriv_tbl</span> <span class='op'>&lt;-</span> <span class='fu'>calc_deriv</span><span class='op'>(</span>init_tbl <span class='op'>=</span> <span class='va'>init_tbl</span>, mod_tbl <span class='op'>=</span> <span class='va'>mod_tbl</span>,
  n_boot <span class='op'>=</span> <span class='fl'>40</span>, par_comp <span class='op'>=</span> <span class='cn'>FALSE</span>, seed<span class='op'>=</span><span class='fl'>1</span>, method <span class='op'>=</span> <span class='st'>"approx_deriv"</span><span class='op'>)</span>
<span class='co'># }</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='https://saskiaotto.de'>Saskia A. Otto</a>, <a href='https://github.com/reneplonus'>Rene Plonus</a>, <a href='https://www.biologie.uni-hamburg.de/forschung/oekologie-biologische-ressourcen/maroeksysdyn/mitarbeiter/funk.html'>Steffen Funk</a>, Alexander Keth.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


